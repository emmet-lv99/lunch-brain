'use server'

import { supabase } from '@/lib/supabase';
import { fetchAllRestaurantsAction } from './fetch-restaurants';

// ğŸ¯ ê°•ë‚¨ì—­ ì£¼ë³€ ë§›ì§‘ ì§€ë„ë¥¼ ì™„ì„±í•  í•„ì‚´ í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸
const HUNTER_KEYWORDS = [
  "ê°•ë‚¨ì—­ ë§›ì§‘", 
  "ê°•ë‚¨ì—­ ì¼ì‹", 
  "ê°•ë‚¨ì—­ í•œì‹", 
  "ê°•ë‚¨ì—­ ê³ ê¸°ì§‘", 
  "ê°•ë‚¨ì—­ ì¹´í˜", 
  "ê°•ë‚¨ì—­ ìˆ ì§‘", 
  "ê°•ë‚¨ì—­ í˜¼ë°¥",
  "ê°•ë‚¨ì—­ ê°€ì„±ë¹„ ë§›ì§‘", 
  "ê°•ë‚¨ì—­ ì†Œê°œíŒ…", 
  "ê°•ë‚¨ì—­ ë””ì €íŠ¸ì¹´í˜",
  "ê°•ë‚¨ì—­ ì´ìì¹´ì•¼",
  "ê°•ë‚¨ì—­ ë¸ŒëŸ°ì¹˜", 
  "ê°•ë‚¨ì—­ ì™€ì¸ë°”", 
  "ê°•ë‚¨ì—­ ì ì‹¬íŠ¹ì„ ", 
  "ê°•ë‚¨ì—­ ë¬´í•œë¦¬í•„", 
  "ê°•ë‚¨ì—­ ìˆ˜ì œë²„ê±°", 
  "ê°•ë‚¨ì—­ ë§ˆë¼íƒ•", 
  "ê°•ë‚¨ì—­ 24ì‹œ ì‹ë‹¹", 
  "ê°•ë‚¨ì—­ ë‹¨ì²´íšŒì‹", 
  "ê°•ë‚¨ì—­ ì¡°ìš©í•œ ì‹ë‹¹",
  "ê°•ë‚¨ì—­ í–„ë²„ê±°", 
  "ê°•ë‚¨ì—­ ìŒ€êµ­ìˆ˜", 
  "ê°•ë‚¨ì—­ ë–¡ë³¶ì´", 
  "ê°•ë‚¨ì—­ íŒŒìŠ¤íƒ€", 
  "ê°•ë‚¨ì—­ ë§ˆë¼íƒ•", 
  "ê°•ë‚¨ì—­ ëˆê¹ŒìŠ¤", 
  "ê°•ë‚¨ì—­ ìš°ë™", 
  "ê°•ë‚¨ì—­ ì†Œë°”", 
  "ê°•ë‚¨ì—­ ì§¬ë½•", 
  "ê°•ë‚¨ì—­ ë‹­ê°ˆë¹„", 
  "ê°•ë‚¨ì—­ ê³±ì°½", 
  "ê°•ë‚¨ì—­ ì‚¼ê²¹ì‚´", 
  "ê°•ë‚¨ì—­ ìŠ¤í…Œì´í¬", 
  "ê°•ë‚¨ì—­ ìƒëŸ¬ë“œ", 
  "ê°•ë‚¨ì—­ ìƒŒë“œìœ„ì¹˜", 
  "ê°•ë‚¨ì—­ í¬ì¼€", 
  "ê°•ë‚¨ì—­ ì»¤ë¦¬", 
  "ê°•ë‚¨ì—­ íƒ€ì½”", 
  "ê°•ë‚¨ì—­ ë”¤ì„¬",
  "ê°•ë‚¨ì—­ ê·œì¹´ì¸ ", "ê°•ë‚¨ì—­ ì‚¬ì¼€ë™", "ê°•ë‚¨ì—­ í…ë™", "ê°•ë‚¨ì—­ ì•¼í‚¤ì†Œë°”", "ê°•ë‚¨ì—­ ì˜¤ì½”ë…¸ë¯¸ì•¼í‚¤",
  "ê°•ë‚¨ì—­ ë¶„ì§œ", "ê°•ë‚¨ì—­ ë‚˜ì‹œê³ ë­", "ê°•ë‚¨ì—­ ë˜ ì–‘ê¿", "ê°•ë‚¨ì—­ í› ê¶ˆ", "ê°•ë‚¨ì—­ ì–‘ê¼¬ì¹˜",
  "ê°•ë‚¨ì—­ í™”ë•í”¼ì", "ê°•ë‚¨ì—­ ë‡¨ë¼", "ê°•ë‚¨ì—­ ë¦¬ì¡°ë˜", "ê°•ë‚¨ì—­ ë¼ìëƒ",
  "ê°•ë‚¨ì—­ ì ¤ë¼ë˜", "ê°•ë‚¨ì—­ ìˆ˜í”Œë ˆíŒ¬ì¼€ì´í¬", "ê°•ë‚¨ì—­ ë§ˆì¹´ë¡±", "ê°•ë‚¨ì—­ ë¹™ìˆ˜", "ê°•ë‚¨ì—­ ë„ë„›",
  "ê°•ë‚¨ì—­ ì¡±ë°œ", "ê°•ë‚¨ì—­ ì•„êµ¬ì°œ", "ê°•ë‚¨ì—­ ìƒ¤ë¸Œìƒ¤ë¸Œ"
];

export async function autoBatchFetchAction() {
  let totalGrandCount = 0;
  console.log("ğŸš€ ëŒ€ê·œëª¨ ìë™ ì‚¬ëƒ¥ ì‘ì „ ê°œì‹œ!");

// 1. ğŸ¯ ì´ë¯¸ ì‚¬ëƒ¥ ì™„ë£Œëœ í‚¤ì›Œë“œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
  const { data: crawledData } = await supabase
    .from('crawled_keywords')
    .select('keyword');
  
  const crawledKeywords = new Set(crawledData?.map(d => d.keyword) || []);

  for (const keyword of HUNTER_KEYWORDS) {
    if (crawledKeywords.has(keyword)) {
      console.log(`â© [${keyword}] ì´ë¯¸ ì •ë³µí•œ ì‚¬ëƒ¥í„°ì…ë‹ˆë‹¤. ê±´ë„ˆëœë‹ˆë‹¤.`);
      continue;
    }   

    try {
      // ì•„ê¹Œ ë§Œë“  fetchAllRestaurantsActionì„ ì¬ì‚¬ìš©í•©ë‹ˆë‹¤.
      const result = await fetchAllRestaurantsAction(keyword);
      if (result.success) {
        totalGrandCount += result.total;
        // 3. ğŸ¯ ì‚¬ëƒ¥ ì„±ê³µ í›„ ê¸°ë¡ì§€ì— ì¶”ê°€
        await supabase.from('crawled_keywords').insert({ keyword });
        console.log(`ğŸ“ [${keyword}] ì‚¬ëƒ¥ ì™„ë£Œ: ${result.total}ê°œ ì¶”ê°€`);
      }
      
      // ğŸ¯ API ê³¼ë¶€í•˜ ë°©ì§€ë¥¼ ìœ„í•œ ë§¤ë„ˆ íƒ€ì„ (0.5ì´ˆ ì‰¬ê¸°)
      await new Promise(resolve => setTimeout(resolve, 500));
      
    } catch (error) {
      console.error(`âŒ [${keyword}] ì‚¬ëƒ¥ ì¤‘ ëŒë°œ ìƒí™©:`, error);
    }
  }

  console.log(`ğŸ ì‘ì „ ì¢…ë£Œ! ì´ ${totalGrandCount}ê°œì˜ ì‹ë‹¹ì„ ì°½ê³ ì— ë„£ì—ˆìŠµë‹ˆë‹¤. ì–´í¥!`);
  return { success: true, total: totalGrandCount };
}